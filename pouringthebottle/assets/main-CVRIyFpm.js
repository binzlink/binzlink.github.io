(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const n of s.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&i(n)}).observe(document,{childList:!0,subtree:!0});function e(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerPolicy&&(s.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?s.credentials="include":o.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(o){if(o.ep)return;o.ep=!0;const s=e(o);fetch(o.href,s)}})();class N{constructor(t,e,i,o=80,s=320){this.layers=[],this.capacity=4,this.isSelected=!1,this.layers=[...t],this.x=e,this.y=i,this.width=o,this.height=s}getLayers(){return[...this.layers]}getTopColor(){return this.layers.length===0?null:this.layers[this.layers.length-1]}getTopColorCount(){if(this.layers.length===0)return 0;const t=this.getTopColor();let e=0;for(let i=this.layers.length-1;i>=0&&this.layers[i]===t;i--)e++;return e}isEmpty(){return this.layers.length===0}isFull(){return this.layers.length>=this.capacity}isCompleted(){if(this.isEmpty()||!this.isFull())return!1;const t=this.layers[0];return this.layers.every(e=>e===t)}getAvailableSpace(){return this.capacity-this.layers.length}addLayers(t){this.layers.push(...t)}removeTopLayers(t){const e=[];for(let i=0;i<t&&this.layers.length>0;i++){const o=this.layers.pop();o&&e.push(o)}return e}containsPoint(t,e){return t>=this.x&&t<=this.x+this.width&&e>=this.y&&e<=this.y+this.height}getFillRatio(){return this.layers.length/this.capacity}setSelected(t){this.isSelected=t}getCapacity(){return this.capacity}getCurrentAmount(){return this.layers.length}}const Y={red:{r:231,g:76,b:60},blue:{r:52,g:152,b:219},green:{r:39,g:174,b:96},yellow:{r:243,g:156,b:18},purple:{r:155,g:89,b:182},orange:{r:230,g:126,b:34},pink:{r:233,g:30,b:99},cyan:{r:0,g:188,b:212},lime:{r:139,g:195,b:74},indigo:{r:63,g:81,b:181},brown:{r:121,g:85,b:72}};class W{constructor(){this.pourSound=null,this.successSound=null,this.completeSound=null,this.isEnabled=!0,this.loadSounds()}loadSounds(){try{this.pourSound=new Audio("/sound.m4a"),this.pourSound.preload="auto",this.pourSound.volume=.6,this.pourSound.loop=!1,this.successSound=new Audio("/success.mp3"),this.successSound.preload="auto",this.successSound.volume=.7,this.successSound.loop=!1,this.completeSound=new Audio("/complete.mp3"),this.completeSound.preload="auto",this.completeSound.volume=.8,this.completeSound.loop=!1}catch(t){console.warn("Èü≥ÊïàÂä†ËΩΩÂ§±Ë¥•:",t),this.isEnabled=!1}}playPourSound(){if(!(!this.isEnabled||!this.pourSound))try{this.pourSound.currentTime=0;const t=this.pourSound.play();t!==void 0&&t.catch(e=>{console.warn("Èü≥ÊïàÊí≠ÊîæÂ§±Ë¥•ÔºàÂèØËÉΩÈúÄË¶ÅÁî®Êà∑‰∫§‰∫íÔºâ:",e)})}catch(t){console.warn("Èü≥ÊïàÊí≠ÊîæÂá∫Èîô:",t)}}stopPourSound(){if(this.pourSound)try{this.pourSound.pause(),this.pourSound.currentTime=0}catch(t){console.warn("Èü≥ÊïàÂÅúÊ≠¢Âá∫Èîô:",t)}}playSuccessSound(){if(!(!this.isEnabled||!this.successSound))try{this.successSound.currentTime=0;const t=this.successSound.play();t!==void 0&&t.catch(e=>{console.warn("ÂÆåÊàêÈü≥ÊïàÊí≠ÊîæÂ§±Ë¥•ÔºàÂèØËÉΩÈúÄË¶ÅÁî®Êà∑‰∫§‰∫íÔºâ:",e)})}catch(t){console.warn("ÂÆåÊàêÈü≥ÊïàÊí≠ÊîæÂá∫Èîô:",t)}}playLevelCompleteSound(){if(!(!this.isEnabled||!this.completeSound))try{this.completeSound.currentTime=0;const t=this.completeSound.play();t!==void 0&&t.catch(e=>{console.warn("ÈÄöÂÖ≥Èü≥ÊïàÊí≠ÊîæÂ§±Ë¥•ÔºàÂèØËÉΩÈúÄË¶ÅÁî®Êà∑‰∫§‰∫íÔºâ:",e)})}catch(t){console.warn("ÈÄöÂÖ≥Èü≥ÊïàÊí≠ÊîæÂá∫Èîô:",t)}}setVolume(t){this.pourSound&&(this.pourSound.volume=Math.max(0,Math.min(1,t)))}setEnabled(t){this.isEnabled=t,t||this.stopPourSound()}getEnabled(){return this.isEnabled}}class ${constructor(){this.currentAnimation=null,this.onComplete=null,this.audioManager=new W}startPourAnimation(t,e,i,o,s=800,n){this.currentAnimation={fromBottle:t,toBottle:e,color:i,layerCount:o,progress:0,duration:s,startTime:Date.now(),soundPlayed:!1},n&&(this.onComplete=n)}update(){if(!this.currentAnimation)return;const t=Date.now()-this.currentAnimation.startTime;this.currentAnimation.progress=Math.min(t/this.currentAnimation.duration,1);const e=$.easeInOutCubic(this.currentAnimation.progress);!this.currentAnimation.soundPlayed&&e>=.5&&(this.audioManager.playPourSound(),this.currentAnimation.soundPlayed=!0),this.currentAnimation.progress>=1&&this.completeAnimation()}completeAnimation(){this.audioManager.stopPourSound(),this.onComplete&&(this.onComplete(),this.onComplete=null),this.currentAnimation=null}getAudioManager(){return this.audioManager}getCurrentAnimation(){return this.currentAnimation}isAnimating(){return this.currentAnimation!==null}static easeInOutCubic(t){return t<.5?4*t*t*t:1-Math.pow(-2*t+2,3)/2}static easeOutQuad(t){return 1-(1-t)*(1-t)}}class D{constructor(t,e,i,o,s,n=3){this.x=t,this.y=e,this.vx=i,this.vy=o,this.color=s,this.size=n,this.life=1}update(t){this.vy+=800*t,this.vx*=.98,this.vy*=.98,this.x+=this.vx*t,this.y+=this.vy*t,this.life-=t*.5}isAlive(){return this.life>0}}const A=class A{constructor(t,e){this.droplets=[],this.lastDropletSpawnTime=0,this.lastUpdateTime=0,this.canvas=t;const i=t.getContext("2d");if(!i)throw new Error("Êó†Ê≥ïËé∑Âèñ Canvas 2D ‰∏ä‰∏ãÊñá");this.ctx=i,this.animationManager=e}clear(){const t=this.canvas.getBoundingClientRect();this.ctx.clearRect(0,0,t.width,t.height)}renderBottles(t){this.clear();const e=this.animationManager.getCurrentAnimation();let i=null;const o=Date.now()/1e3;this.lastUpdateTime===0&&(this.lastUpdateTime=o);const s=Math.min(o-this.lastUpdateTime,.1);this.lastUpdateTime=o,e?this.updateParticles(s,e):(this.droplets=[],this.lastDropletSpawnTime=0),t.forEach(n=>{const a=!!(e&&e.fromBottle===n),r=!!(e&&e.toBottle===n);if(a){i=n;return}this.renderBottle(n,!1,r,e)}),i&&e&&this.renderBottle(i,!0,!1,e),e&&this.renderParticles()}renderBottle(t,e,i,o){const s=this.ctx;let{x:n,y:a,width:r,height:l}=t;const u=20;let d=0;if(t.isSelected){d=u,s.save(),s.beginPath(),s.ellipse(t.x+t.width/2,t.y+t.height+10,t.width/2+5,8,0,0,Math.PI*2);const g=s.createRadialGradient(t.x+t.width/2,t.y+t.height+10,0,t.x+t.width/2,t.y+t.height+10,t.width/2+5);g.addColorStop(0,"rgba(0, 0, 0, 0.3)"),g.addColorStop(1,"rgba(0, 0, 0, 0)"),s.fillStyle=g,s.fill(),s.restore(),a-=u}e&&o&&(s.save(),this.applyPourTransform(t,o,d));const c=t.isCompleted();this.drawBottleContainer(n,a,r,l,t.isSelected,c);let f=t.getLayers();if(e&&o){const g=$.easeInOutCubic(o.progress),m=Math.max(0,(g-.5)/.5),h=Math.floor(o.layerCount*m);f=f.slice(0,f.length-h)}this.drawLiquidLayers(n,a,r,l,f,t.getCapacity(),e?o:null),e&&o&&this.spawnDroplets(n,a,r,l,f,t.getCapacity(),o),e&&o&&s.restore(),t.isCompleted()&&this.drawCompletedEffect(n,a,r,l)}drawBottleContainer(t,e,i,o,s,n){const a=this.ctx,r=o*.05,l=i*1.1,u=t-(l-i)/2;a.save(),a.beginPath(),a.moveTo(u,e),a.lineTo(u+l,e),a.quadraticCurveTo(u+l,e+r,t+i,e+r),a.lineTo(t+i,e+o-15),a.quadraticCurveTo(t+i,e+o,t+i-15,e+o),a.lineTo(t+15,e+o),a.quadraticCurveTo(t,e+o,t,e+o-15),a.lineTo(t,e+r),a.quadraticCurveTo(u,e+r,u,e),a.closePath();const d=a.createLinearGradient(t,e,t+i,e);d.addColorStop(0,"rgba(255, 255, 255, 0.3)"),d.addColorStop(.5,"rgba(255, 255, 255, 0.1)"),d.addColorStop(1,"rgba(255, 255, 255, 0.2)"),a.fillStyle=d,a.fill(),a.strokeStyle="rgba(200, 200, 200, 0.4)",a.lineWidth=1.5,a.shadowBlur=0,a.stroke(),a.restore(),this.drawGlassHighlight(t,e,i,o)}drawGlassHighlight(t,e,i,o){const s=this.ctx;s.save(),s.beginPath(),s.ellipse(t+i*.3,e+o*.3,i*.15,o*.35,0,0,Math.PI*2);const n=s.createRadialGradient(t+i*.3,e+o*.3,0,t+i*.3,e+o*.3,i*.15);n.addColorStop(0,"rgba(255, 255, 255, 0.4)"),n.addColorStop(1,"rgba(255, 255, 255, 0)"),s.fillStyle=n,s.fill(),s.restore()}drawLiquidLayers(t,e,i,o,s,n,a=null){if(s.length===0)return;const r=this.ctx,l=o*.05,u=10,f=(o-l-u-5)/n,g=a!==null,m=g?$.easeInOutCubic(a.progress):0;let h=0,p=!1;g&&(p=a.fromBottle.x<a.toBottle.x,h=2*Math.PI/3*Math.min(m*1.2,1)*(p?1:-1)),g?this.drawTiltedLiquid(t,e,i,o,s,n,h,p):s.forEach((S,P)=>{const b=e+o-u-(P+1)*f;r.save(),r.beginPath();const M=i*.08,v=t+M,T=i-M*2,L=f;this.drawRoundedRect(v,b,T,L+1,2);const y=Y[S],C=r.createLinearGradient(v,b,v+T,b);C.addColorStop(0,`rgba(${y.r}, ${y.g}, ${y.b}, 0.9)`),C.addColorStop(.5,`rgba(${y.r}, ${y.g}, ${y.b}, 1)`),C.addColorStop(1,`rgba(${y.r}, ${y.g}, ${y.b}, 0.9)`),r.fillStyle=C,r.fill(),P===s.length-1&&(r.beginPath(),r.ellipse(v+T/2,b+3,T/2-M*.6,3,0,0,Math.PI*2),r.fillStyle="rgba(255, 255, 255, 0.3)",r.fill()),r.restore()})}drawTiltedLiquid(t,e,i,o,s,n,a,r){const l=this.ctx,u=o*.05,d=10,g=(o-u-d-5)/n,m=i*.08,h=t+m,p=i-m*2,S=e+o-d,P=2*Math.PI/3,b=Math.abs(a)/P,v=g*.6*b;s.forEach((T,L)=>{l.save();const y=L===s.length-1;if(l.beginPath(),y){const w=S-L*g,E=S-(L+1)*g;r?(l.moveTo(h,w),l.lineTo(h+p,w),l.lineTo(h+p,E),l.lineTo(h,E+v)):(l.moveTo(h,w),l.lineTo(h+p,w),l.lineTo(h+p,E+v),l.lineTo(h,E))}else{const w=S-(L+1)*g;this.drawRoundedRect(h,w,p,g+1,2)}l.closePath();const C=Y[T],B=S-(L+1)*g,I=l.createLinearGradient(h,B,h+p,B);I.addColorStop(0,`rgba(${C.r}, ${C.g}, ${C.b}, 0.9)`),I.addColorStop(.5,`rgba(${C.r}, ${C.g}, ${C.b}, 1)`),I.addColorStop(1,`rgba(${C.r}, ${C.g}, ${C.b}, 0.9)`),l.fillStyle=I,l.fill(),l.restore()})}spawnDroplets(t,e,i,o,s,n,a){const{progress:r,toBottle:l,fromBottle:u}=a;if($.easeInOutCubic(r)<.5||s.length===0)return;const c=this.ctx,f=u.x<l.x,m=u.isSelected?20:0,h=u.height*.05,p=25,S=f?-A.NECK_HORIZONTAL_OFFSET:A.NECK_HORIZONTAL_OFFSET,P=l.x+l.width/2+S,b=l.y+A.NECK_HEIGHT_OFFSET+h+p-m,M=-20,v=P+(f?M:-M),T=b,L=s[s.length-1];c.restore(),c.save();const y=Date.now()/1e3,B=1/60;if(y-this.lastDropletSpawnTime>=B){const I=f?50:-50,w=20,E=I+(Math.random()-.5)*40,O=w+(Math.random()-.5)*20,z=3+Math.random()*3;this.droplets.push(new D(v,T,E,O,L,z)),this.lastDropletSpawnTime=y}}updateParticles(t,e){const{toBottle:i}=e,o=i.getLayers().length,s=i.getCapacity(),n=i.height*.05,a=10,u=(i.height-n-a-5)/s,d=i.y+i.height-a-o*u;this.droplets.forEach(c=>{c.update(t),c.y>=d&&c.x>=i.x&&c.x<=i.x+i.width&&(c.life=0),(c.y>this.canvas.height+100||c.y<-100||c.x>this.canvas.width+100||c.x<-100)&&(c.life=0)}),this.droplets=this.droplets.filter(c=>c.isAlive())}renderParticles(){const t=this.ctx;this.droplets.forEach(e=>{const i=Y[e.color];t.save(),t.globalAlpha=e.life*.9,t.beginPath(),t.arc(e.x,e.y,e.size,0,Math.PI*2);const o=t.createRadialGradient(e.x-e.size*.3,e.y-e.size*.3,0,e.x,e.y,e.size);o.addColorStop(0,`rgba(${i.r}, ${i.g}, ${i.b}, 1)`),o.addColorStop(.6,`rgba(${i.r}, ${i.g}, ${i.b}, 0.9)`),o.addColorStop(1,`rgba(${i.r}, ${i.g}, ${i.b}, 0.7)`),t.fillStyle=o,t.fill();const s=Math.sqrt(e.vx*e.vx+e.vy*e.vy);if(s>50){const n=Math.min(s*.1,15),a=Math.atan2(e.vy,e.vx),r=e.x-Math.cos(a)*n,l=e.y-Math.sin(a)*n;t.beginPath(),t.moveTo(e.x,e.y),t.lineTo(r,l),t.strokeStyle=`rgba(${i.r}, ${i.g}, ${i.b}, ${e.life*.5})`,t.lineWidth=e.size*.6,t.lineCap="round",t.stroke()}t.beginPath(),t.arc(e.x-e.size*.3,e.y-e.size*.3,e.size*.4,0,Math.PI*2),t.fillStyle=`rgba(255, 255, 255, ${e.life*.6})`,t.fill(),t.restore()})}drawRoundedRect(t,e,i,o,s){const n=this.ctx;n.beginPath(),n.moveTo(t+s,e),n.lineTo(t+i-s,e),n.quadraticCurveTo(t+i,e,t+i,e+s),n.lineTo(t+i,e+o-s),n.quadraticCurveTo(t+i,e+o,t+i-s,e+o),n.lineTo(t+s,e+o),n.quadraticCurveTo(t,e+o,t,e+o-s),n.lineTo(t,e+s),n.quadraticCurveTo(t,e,t+s,e),n.closePath()}applyPourTransform(t,e,i=0){const o=this.ctx,{toBottle:s,progress:n}=e,a=$.easeInOutCubic(n),r=t.x<s.x,u=2*Math.PI/3*Math.min(a*1.2,1)*(r?1:-1),d=s.x+s.width/2,c=s.y,f=t.x+t.width/2,g=t.y-i,m=r?-A.NECK_HORIZONTAL_OFFSET:A.NECK_HORIZONTAL_OFFSET,h=d-f+m,p=c-g+A.NECK_HEIGHT_OFFSET,S=Math.min(a*1.2,1),P=h*S,b=p*S,M=f+P,v=g+b;o.translate(M,v),o.rotate(u),o.translate(-f,-g)}drawCompletedEffect(t,e,i,o){this.drawBottleCork(t,e,i)}drawBottleCork(t,e,i){const o=this.ctx,s=i*.7,n=i*.25,a=t+(i-s)/2,r=e-n*.6;o.save(),o.beginPath(),o.moveTo(a+s*.15,r),o.lineTo(a+s*.85,r),o.quadraticCurveTo(a+s,r,a+s,r+n*.2),o.lineTo(a+s,r+n*.8),o.quadraticCurveTo(a+s,r+n,a+s*.85,r+n),o.lineTo(a+s*.15,r+n),o.quadraticCurveTo(a,r+n,a,r+n*.8),o.lineTo(a,r+n*.2),o.quadraticCurveTo(a,r,a+s*.15,r),o.closePath();const l=o.createLinearGradient(a,r,a+s,r);l.addColorStop(0,"#D4A574"),l.addColorStop(.5,"#C8956E"),l.addColorStop(1,"#D4A574"),o.fillStyle=l,o.fill(),o.strokeStyle="#A67C52",o.lineWidth=1.5,o.stroke(),o.beginPath(),o.ellipse(a+s/2,r+n*.25,s*.3,n*.15,0,0,Math.PI*2),o.fillStyle="rgba(255, 255, 255, 0.3)",o.fill(),o.strokeStyle="rgba(166, 124, 82, 0.4)",o.lineWidth=1;for(let u=0;u<3;u++){const d=r+n*(.3+u*.2);o.beginPath(),o.moveTo(a+s*.2,d),o.lineTo(a+s*.8,d),o.stroke()}o.restore()}resize(t,e){this.canvas.width=t,this.canvas.height=e}getCanvas(){return this.canvas}drawDebugCoordinates(t){const{fromBottle:e,toBottle:i,progress:o}=t,s=this.ctx,n=$.easeInOutCubic(o);s.save();const a=e.x<i.x,r=a?-1:1,u=Math.PI/4*Math.min(n*1.5,1)*r,d=i.x+i.width/2,c=i.y;s.strokeStyle="#ff0000",s.lineWidth=2,s.beginPath(),s.moveTo(d-100,c),s.lineTo(d+100,c),s.stroke(),s.beginPath(),s.moveTo(d,c-100),s.lineTo(d,c+100),s.stroke(),s.fillStyle="#ff0000",s.font="bold 14px Arial",s.fillText("ÁõÆÊ†áÁì∂Âè£ (0,0)",d+10,c-10),s.beginPath(),s.arc(d,c,5,0,Math.PI*2),s.fill();const f=e.x+e.width/2,g=e.y,m=d-f,h=c-g,p=Math.min(n*1.2,1),S=m*p,P=h*p,b=f+S,M=g+P,v=d,T=c;s.fillStyle="#ff0000",s.beginPath(),s.arc(v,T,10,0,Math.PI*2),s.fill(),s.fillText(`ÊóãËΩ¨‰∏≠ÂøÉ(ÁõÆÊ†áÁì∂Âè£) Y=${T.toFixed(0)}`,v+15,T-15);const L=f+S,y=g+P;s.fillStyle="#0000ff",s.beginPath(),s.arc(L,y,8,0,Math.PI*2),s.fill(),s.fillText(`Ê∫êÁì∂Âè£Â∫îËØ•Âú®ËøôÈáå (${L.toFixed(0)}, ${y.toFixed(0)})`,L+15,y+15),s.strokeStyle="#00ff00",s.lineWidth=2,s.beginPath(),s.arc(L,y,15,0,Math.PI*2),s.stroke();const C=b,B=M+e.height;s.fillStyle="#00ff00",s.beginPath(),s.arc(C,B,8,0,Math.PI*2),s.fill(),s.fillText(`Âπ≥ÁßªÂêéÁì∂Â∫ï Y=${B.toFixed(0)}`,C+15,B);const I=e.height*Math.sin(u),w=e.height*Math.cos(Math.abs(u)),E=v+I,O=T+w;s.fillStyle="#ff00ff",s.beginPath(),s.arc(E,O,10,0,Math.PI*2),s.fill(),s.fillText(`ÊóãËΩ¨ÂêéÁì∂Â∫ï Y=${O.toFixed(0)}`,E+15,O+20),s.strokeStyle="#ffff00",s.lineWidth=3,s.beginPath(),s.moveTo(v,T),s.lineTo(E,O),s.stroke(),s.fillStyle="#ffffff",s.fillRect(10,10,400,130),s.fillStyle="#000000",s.font="14px Arial",s.fillText(`ÂÄæÊñúËßíÂ∫¶: ${(u*180/Math.PI).toFixed(1)}¬∞`,20,30),s.fillText(`ÊñπÂêë: ${a?"Â∑¶‚ÜíÂè≥":"Âè≥‚ÜíÂ∑¶"}`,20,50),s.fillText(`ÊóãËΩ¨ÂêéÁì∂Â∫ïY < Áì∂Âè£Y: ${O<T?"‚úì Ê≠£Á°Æ!":"‚úó ÈîôËØØ!"}`,20,70),s.fillText(`Áì∂Â∫ïÊä¨È´ò‰∫Ü: ${Math.abs(O-B).toFixed(0)} px`,20,90),s.fillText(`Áì∂Âè£ÂÅèÁßª: ${Math.abs(L-v).toFixed(1)} px`,20,110),s.fillText("ËìùËâ≤=Ê∫êÁì∂Âè£Â∫îÂú®‰ΩçÁΩÆ, ÁªøÂúà=È™åËØÅÂúà",20,125),s.restore()}};A.NECK_HEIGHT_OFFSET=-60,A.NECK_HORIZONTAL_OFFSET=-25;let R=A;const H=class H{static generateLevels(){const t=[];for(let e=1;e<=this.TOTAL_LEVELS;e++)t.push(this.generateLevel(e));return t}static generateLevel(t){const e=Math.min(t,11);let i,o;t===1?(i=2,o=0):t===2?(i=3,o=1):(i=e+2,o=2);const s=i-o,n=Math.min((t-1)/99,1),r=["red","blue","green","yellow","purple","orange","pink","cyan","lime","indigo","brown"].slice(0,e),l=[];r.forEach(h=>{for(let p=0;p<4;p++)l.push(h)});const u=1+Math.floor(n*5);for(let h=0;h<u;h++)this.shuffleWithSeed(l,t*1e3+h);const d=[],c=4;for(let h=0;h<s;h++)d.push([]);let f=t*12345;const g=()=>(f=(f*9301+49297)%233280,f/233280);let m=0;for(const h of l){for(;d[m].length>=c;)m=(m+1)%s;d[m].push(h),g()<.3+n*.4&&(m=(m+1)%s)}for(let h=0;h<o;h++)d.push([]);return{level:t,bottles:d}}static shuffleWithSeed(t,e){let i=e;const o=()=>(i=(i*9301+49297)%233280,i/233280);for(let s=t.length-1;s>0;s--){const n=Math.floor(o()*(s+1));[t[s],t[n]]=[t[n],t[s]]}}static getLevel(t){if(t<1||t>this.TOTAL_LEVELS)return null;this.levels||(this.levels=this.generateLevels());const e=this.levels[t-1];return e?JSON.parse(JSON.stringify(e)):null}static getTotalLevels(){return this.TOTAL_LEVELS}static getAllLevels(){return this.levels||(this.levels=this.generateLevels()),JSON.parse(JSON.stringify(this.levels))}};H.TOTAL_LEVELS=100,H.levels=null;let k=H;class X{constructor(t){this.bottles=[],this.currentLevel=1,this.selectedBottleIndex=null,this.completedLevels=new Set,this.isRunning=!1,this.canvas=t,this.animationManager=new $,this.renderer=new R(t,this.animationManager),this.initializeCanvas(),this.setupEventListeners(),this.loadProgress(),this.loadLevel(this.currentLevel),this.start()}initializeCanvas(){this.resizeCanvas(),window.addEventListener("resize",()=>this.resizeCanvas())}resizeCanvas(){const t=window.devicePixelRatio||1,e=this.canvas.getBoundingClientRect();this.canvas.width=e.width*t,this.canvas.height=e.height*t;const i=this.canvas.getContext("2d");i&&i.scale(t,t),this.canvas.style.width=e.width+"px",this.canvas.style.height=e.height+"px",this.repositionBottles()}repositionBottles(){const t=this.canvas.getBoundingClientRect(),e=this.bottles.length,i=t.width*.08,o=t.height*.1,s=t.height*.08,n=t.width-i*2,a=t.height-o-s;let d=this.calculateBestLayout(e,n,a,60,100,4);const{cols:c,bottleWidth:f,bottleHeight:g,horizontalGap:m,verticalGap:h}=d,p=Math.ceil(e/c),S=c*f+(c-1)*m,P=p*g+(p-1)*h,b=(t.width-S)/2,M=(t.height-P)/2;this.bottles.forEach((v,T)=>{const L=Math.floor(T/c),y=T%c;v.x=b+y*(f+m),v.y=M+L*(g+h),v.width=f,v.height=g})}calculateBestLayout(t,e,i,o,s,n){let a={cols:t,bottleWidth:o,bottleHeight:o*n,horizontalGap:o*.3,verticalGap:o*.4},r=-1;for(let l=1;l<=t;l++){const u=Math.ceil(t/l),d=.3;let c=e/(l+(l-1)*d);c=Math.max(o,Math.min(s,c));const f=c*d,g=c*.4,m=c*n,h=l*c+(l-1)*f,p=u*m+(u-1)*g;if(h<=e&&p<=i){const S=h/e*(p/i),P=c/s,b=S*.5+P*.5;b>r&&(r=b,a={cols:l,bottleWidth:c,bottleHeight:m,horizontalGap:f,verticalGap:g})}}return a}setupEventListeners(){this.canvas.addEventListener("click",t=>this.handleClick(t))}handleClick(t){if(this.animationManager.isAnimating())return;const e=this.canvas.getBoundingClientRect(),i=t.clientX-e.left,o=t.clientY-e.top,s=this.bottles.findIndex(n=>n.containsPoint(i,o));if(s!==-1)if(this.selectedBottleIndex===null){if(this.bottles[s].isEmpty())return;this.selectBottle(s)}else s===this.selectedBottleIndex?this.deselectBottle():this.attemptPour(this.selectedBottleIndex,s)}selectBottle(t){this.selectedBottleIndex=t,this.bottles[t].setSelected(!0)}deselectBottle(){this.selectedBottleIndex!==null&&(this.bottles[this.selectedBottleIndex].setSelected(!1),this.selectedBottleIndex=null)}attemptPour(t,e){const i=this.bottles[t],o=this.bottles[e];if(!this.canPour(i,o)){this.deselectBottle();return}this.pourLiquid(t,e)}canPour(t,e){if(t.isEmpty()||e.isFull())return!1;const i=t.getTopColor();if(!i)return!1;if(e.isEmpty())return!0;const o=e.getTopColor();return i===o}pourLiquid(t,e){const i=this.bottles[t],o=this.bottles[e],s=i.getTopColor(),n=i.getTopColorCount(),a=o.getAvailableSpace(),r=Math.min(n,a),l=o.isCompleted();this.animationManager.startPourAnimation(i,o,s,r,1500,()=>{const u=i.removeTopLayers(r);o.addLayers(u.reverse()),!l&&o.isCompleted()&&this.animationManager.getAudioManager().playSuccessSound(),this.deselectBottle(),setTimeout(()=>this.checkWin(),300)})}checkWin(){const t=new Set;this.bottles.forEach(i=>{i.getLayers().forEach(o=>t.add(o))}),this.bottles.filter(i=>i.isCompleted()).length===t.size&&t.size>0&&this.onLevelComplete()}onLevelComplete(){this.completedLevels.add(this.currentLevel),this.saveProgress(),this.animationManager.getAudioManager().playLevelCompleteSound(),setTimeout(()=>{this.showWinModal()},500)}showWinModal(){const t=document.getElementById("winModal");t&&(t.style.display="block",this.createConfetti())}createConfetti(){const t=["#667eea","#764ba2","#f093fb","#4facfe","#00f2fe","#ffd89b"];for(let e=0;e<80;e++)setTimeout(()=>{this.createSingleConfetti(t[Math.floor(Math.random()*t.length)])},e*20)}createSingleConfetti(t){const e=document.createElement("div");e.style.position="fixed",e.style.width="10px",e.style.height="10px",e.style.backgroundColor=t,e.style.left=Math.random()*window.innerWidth+"px",e.style.top="-10px",e.style.opacity="1",e.style.zIndex="9999",e.style.borderRadius=Math.random()>.5?"50%":"0",e.style.pointerEvents="none",document.body.appendChild(e);const i=2e3+Math.random()*1e3,o=window.innerHeight+10,s=Date.now(),n=(Math.random()-.5)*200,a=()=>{const l=(Date.now()-s)/i;l<1?(e.style.top=l*o+"px",e.style.left=parseFloat(e.style.left)+n*.016+"px",e.style.opacity=String(1-l),e.style.transform=`rotate(${l*720}deg)`,requestAnimationFrame(a)):e.remove()};a()}loadLevel(t){const e=k.getLevel(t);if(e)this.loadLevelData(e);else{t=1;const i=k.getLevel(1);if(!i)return;this.loadLevelData(i)}this.currentLevel=t,this.updateLevelDisplay()}updateLevelDisplay(){const t=document.getElementById("levelNumber");t&&(t.textContent=String(this.currentLevel))}loadLevelData(t){this.bottles=[],this.selectedBottleIndex=null,t.bottles.forEach(e=>{const i=new N(e,0,0);this.bottles.push(i)}),this.repositionBottles()}nextLevel(){const t=this.currentLevel+1,e=k.getTotalLevels();t>e?this.loadLevel(1):this.loadLevel(t),this.closeWinModal()}resetLevel(){this.loadLevel(this.currentLevel),this.closeWinModal()}closeWinModal(){const t=document.getElementById("winModal");t&&(t.style.display="none")}saveProgress(){const t=Array.from(this.completedLevels);localStorage.setItem("completedLevels",JSON.stringify(t))}loadProgress(){const t=localStorage.getItem("completedLevels");if(t){const e=JSON.parse(t);this.completedLevels=new Set(e)}}start(){this.isRunning=!0,this.gameLoop()}gameLoop(){this.isRunning&&(this.animationManager.update(),this.renderer.renderBottles(this.bottles),requestAnimationFrame(()=>this.gameLoop()))}stop(){this.isRunning=!1}getAnimationManager(){return this.animationManager}}let q=null;function F(){const x=document.getElementById("gameCanvas");if(!x){console.error("Êâæ‰∏çÂà∞ canvas ÂÖÉÁ¥†");return}q=new X(x),window.nextLevel=()=>q?.nextLevel(),window.resetLevel=()=>q?.resetLevel(),G()}function G(){const x=document.getElementById("audioToggle");!x||!q||x.addEventListener("click",()=>{const t=q?.getAnimationManager().getAudioManager();if(!t)return;const e=t.getEnabled();t.setEnabled(!e),e?(x.textContent="üîá",x.classList.add("muted"),x.setAttribute("title","Èü≥ÊïàÔºöÂÖ≥Èó≠")):(x.textContent="üîä",x.classList.remove("muted"),x.setAttribute("title","Èü≥ÊïàÔºöÂºÄÂêØ"))})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",F):F();
